const commandLineArgs = require('command-line-args');
const optionDefinitions = [
  {
    name: 'path',
    alias: 'p',
  },
  {
    name: 'username',
    alias: 'u',
  },
  {
    name: 'dump',
    alias: 'd',
  }
]
const options = commandLineArgs(optionDefinitions);

var csv = require('csvtojson');

csv({
  noheader: true,
  headers: [
    'code',
    'date',
    'depertmentcode',
    'depertment',
    'staffnumber',
    'name',
    'payment1.key',
    'payment1.value',
    'payment2.key',
    'payment2.value',
    'payment3.key',
    'payment3.value',
    'payment4.key',
    'payment4.value',
    'payment5.key',
    'payment5.value',
    'payment6.key',
    'payment6.value',
    'payment7.key',
    'payment7.value',
    'payment8.key',
    'payment8.value',
    'payment9.key',
    'payment9.value',
    'payment10.key',
    'payment10.value',
    'payment11.key',
    'payment11.value',
    'payment12.key',
    'payment12.value',
    'payment13.key',
    'payment13.value',
    'payment14.key',
    'payment14.value',
    'payment15.key',
    'payment15.value',
    'payment16.key',
    'payment16.value',
    'payment17.key',
    'payment17.value',
    'payment18.key',
    'payment18.value',
    'payment19.key',
    'payment19.value',
    'payment20.key',
    'payment20.value',
    'payment21.key',
    'payment21.value',
    'payment22.key',
    'payment22.value',
    'payment23.key',
    'payment23.value',
    'payment24.key',
    'payment24.value',
    'payment25.key',
    'payment25.value',
    'payment26.key',
    'payment26.value',
    'payment27.key',
    'payment27.value',
    'payment28.key',
    'payment28.value',
    'deduction1.key',
    'deduction1.value',
    'deduction2.key',
    'deduction2.value',
    'deduction3.key',
    'deduction3.value',
    'deduction4.key',
    'deduction4.value',
    'deduction5.key',
    'deduction5.value',
    'deduction6.key',
    'deduction6.value',
    'deduction7.key',
    'deduction7.value',
    'deduction8.key',
    'deduction8.value',
    'deduction9.key',
    'deduction9.value',
    'deduction10.key',
    'deduction10.value',
    'deduction11.key',
    'deduction11.value',
    'deduction12.key',
    'deduction12.value',
    'deduction13.key',
    'deduction13.value',
    'deduction14.key',
    'deduction14.value',
    'deduction15.key',
    'deduction15.value',
    'deduction16.key',
    'deduction16.value',
    'deduction17.key',
    'deduction17.value',
    'deduction18.key',
    'deduction18.value',
    'deduction19.key',
    'deduction19.value',
    'deduction20.key',
    'deduction20.value',
    'deduction21.key',
    'deduction21.value',
    'deduction22.key',
    'deduction22.value',
    'deduction23.key',
    'deduction23.value',
    'deduction24.key',
    'deduction24.value',
    'deduction25.key',
    'deduction25.value',
    'deduction26.key',
    'deduction26.value',
    'deduction27.key',
    'deduction27.value',
    'deduction28.key',
    'deduction28.value',
    'deduction29.key',
    'deduction29.value',
    'deduction30.key',
    'deduction30.value',
    'deduction31.key',
    'deduction31.value',
    'summary1.key',
    'summary1.value',
    'summary2.key',
    'summary2.value',
    'summary3.key',
    'summary3.value',
    'summary4.key',
    'summary4.value',
    'summary5.key',
    'summary5.value',
    'summary6.key',
    'summary6.value',
    'summary7.key',
    'summary7.value',
    'summary8.key',
    'summary8.value',
    'summary9.key',
    'summary9.value',
    'field140',
    'field141',
    'field142',
    'field143',
    'field144',
    'field145',
    'field146',
    'field147',
    'field148'
  ],
  colParser: {
    'payment1.value': 'number',
    'payment2.value': 'number',
    'payment3.value': 'number',
    'payment4.value': 'number',
    'payment5.value': 'number',
    'payment6.value': 'number',
    'payment7.value': 'number',
    'payment8.value': 'number',
    'payment9.value': 'number',
    'payment10.value': 'number',
    'payment11.value': 'number',
    'payment12.value': 'number',
    'payment13.value': 'number',
    'payment14.value': 'number',
    'payment15.value': 'number',
    'payment16.value': 'number',
    'payment17.value': 'number',
    'payment18.value': 'number',
    'payment19.value': 'number',
    'payment20.value': 'number',
    'payment21.value': 'number',
    'payment22.value': 'number',
    'payment23.value': 'number',
    'payment24.value': 'number',
    'payment25.value': 'number',
    'payment26.value': 'number',
    'payment27.value': 'number',
    'payment28.value': 'number',
    'deduction1.value': 'number',
    'deduction2.value': 'number',
    'deduction3.value': 'number',
    'deduction4.value': 'number',
    'deduction5.value': 'number',
    'deduction6.value': 'number',
    'deduction7.value': 'number',
    'deduction8.value': 'number',
    'deduction9.value': 'number',
    'deduction10.value': 'number',
    'deduction11.value': 'number',
    'deduction12.value': 'number',
    'deduction13.value': 'number',
    'deduction14.value': 'number',
    'deduction15.value': 'number',
    'deduction16.value': 'number',
    'deduction17.value': 'number',
    'deduction18.value': 'number',
    'deduction19.value': 'number',
    'deduction20.value': 'number',
    'deduction21.value': 'number',
    'deduction22.value': 'number',
    'deduction23.value': 'number',
    'deduction24.value': 'number',
    'deduction25.value': 'number',
    'deduction26.value': 'number',
    'deduction27.value': 'number',
    'deduction28.value': 'number',
    'deduction29.value': 'number',
    'deduction30.value': 'number',
    'deduction31.value': 'number',
    'summary1.value': 'number',
    'summary2.value': 'number',
    'summary3.value': 'number',
    'summary4.value': 'number',
    'summary5.value': 'number',
    'summary6.value': 'number',
    'summary7.value': 'number',
    'summary8.value': 'number',
    'summary9.value': 'number',
  }
}
)
  .fromFile(options.path)
  .then((jsonObj) => {
    const options = commandLineArgs(optionDefinitions);
    if(options.dump){ console.log(jsonObj)};
    // setup data
    var records = new Object([]);
    for (record of jsonObj) {
      records.push({ 
        "Key__c": record.staffnumber + "-" + record.date.substr(0, 4) + "-" + record.code,
        "Salary__r.Key__c" : record.staffnumber + "-" + record.date.substr(0, 4),
        "PaymentDate__c" : record.date.split('/').join('-'),
        //"PaymentAmount__c" :
        "payment1label__c" : record.payment1.key,
        "payment1__c" : record.payment1.value,
        "payment3label__c" : record.payment3.key,
        "payment3__c" : record.payment3.value,
        "payment4label__c" : record.payment4.key,
        "payment4__c" : record.payment4.value,
        "payment5label__c" : record.payment5.key,
        "payment5__c" : record.payment5.value,
        "payment28label__c" : record.payment28.key,
        "payment28__c" : record.payment28.value,
        "deduction1label__c" : record.deduction1.key,
        "deduction1__c" : record.deduction1.value,
        "deduction3label__c" : record.deduction3.key,
        "deduction3__c" : record.deduction3.value,
        "deduction4label__c" : record.deduction4.key,
        "deduction4__c" : record.deduction4.value,
        "deduction5label__c" : record.deduction5.key,
        "deduction5__c" : record.deduction5.value,
        "deduction6label__c" : record.deduction6.key,
        "deduction6__c" : record.deduction6.value,
        "deduction7label__c" : record.deduction7.key,
        "deduction7__c" : record.deduction7.value,
        "deduction28label__c" : record.deduction28.key,
        "deduction28__c" : record.deduction28.value,
        "summary1__c" : record.summary1.value,
        "summary3label__c" : record.summary3.key,
        "summary3__c" : record.summary3.value,
        "summary4label__c" : record.summary4.key,
        "summary4__c" : record.summary4.value,
        "summary5label__c" : record.summary5.key,
        "summary5__c" : record.summary5.value,
        "summary6label__c" : record.summary6.key,
        "summary6__c" : record.summary6.value,
        "summary7label__c" : record.summary7.key,
        "summary7__c" : record.summary7.value,
        "summary8label__c" : record.summary8.key,
        "summary8__c" : record.summary8.value,
        "summary9label__c" : record.summary9.key,
        "summary9__c" : record.summary9.value,
        
      });
    }

    console.log(records);

    const { AuthInfo, Connection } = require('@salesforce/core');

    (async () => {
      const conn = await Connection.create({
        authInfo: await AuthInfo.create({ username: options.username })
      });
      console.log('Connected');

     conn.bulk.load("SalaryDetail__c", "upsert",{extIdField: 'Key__c'}, records,  function(err, rets) {
      if (err) { return console.error(err); }
      for (var i=0; i < rets.length; i++) {
        if (rets[i].success) {
          console.log("#" + (i+1) + " loaded successfully, id = " + rets[i].id);
        } else {
          console.log("#" + (i+1) + " error occurred, message = " + rets[i].errors.join(', '));
        }
      }
      
    });

    })().catch(error => console.error(error))
  })
